<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 Image Upload Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQuery CDN -->
</head>
<body>

    <h1>Base64 Image Upload Test</h1>

    <!-- 이미지를 선택하는 input 필드 -->
    <input type="file" id="imageInput" accept="image/*">
    <br><br>

    <!-- 업로드된 이미지를 미리 보기 위한 img 태그 -->
    <img id="imagePreview" src="" alt="Image Preview" style="max-width: 300px; display: none;">
    
    <br><br>

    <button onclick="uploadBase64Image()">Upload Image</button>

    <script>
        // 이미지 선택 후 미리보기
        document.getElementById('imageInput').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    // 미리보기 이미지 표시
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);  // 파일을 base64 형식으로 읽어옴
            }
        });

        // Base64를 Blob 객체로 변환하는 함수
        function base64ToBlob(base64, mimeType) {
            var byteCharacters = atob(base64.split(',')[1]);  // Base64 디코딩 (헤더 제거)
            var byteArrays = [];
          
            // Base64 데이터를 1024 byte씩 나누어 Blob 생성
            for (var offset = 0; offset < byteCharacters.length; offset += 1024) {
                var slice = byteCharacters.slice(offset, offset + 1024);
                var byteNumbers = new Array(slice.length);
                
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                
                var byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
          
            // Blob 객체 생성
            return new Blob(byteArrays, { type: mimeType });
        }

        // Base64로 변환된 이미지를 서버에 업로드하는 함수
        function uploadBase64Image() {
            var base64String = document.getElementById('imagePreview').src;  // Base64 문자열 (이미지 미리보기)
            if (!base64String) {
                alert('이미지를 선택하세요!');
                return;
            }

            var mimeType = "image/png";  // 이미지 MIME 타입 (현재는 PNG로 설정)
            
            // Base64를 Blob으로 변환
            var blob = base64ToBlob(base64String, mimeType);
            
            // FormData 생성
            var formData = new FormData();
            formData.append('image', blob, 'image.png');  // 'image.png'는 파일 이름 (확장자 설정)
            
            // localStorage에서 access token 가져오기
            const accessToken = localStorage.getItem("access_token");

            // API 호출 (서버로 FormData 전송)
            $.ajax({
                url: 'http://127.0.0.1:8000/api/articles/',  // 실제 서버 API 경로로 변경
                type: 'POST',
                data: formData,
                contentType: false,  // jQuery가 자동으로 'multipart/form-data'로 설정하도록 false로 지정
                processData: false,  // jQuery가 데이터를 자동으로 처리하지 않도록 false로 설정
                headers: {
                    "Authorization": `Bearer ${accessToken}`  // Authorization 헤더에 Bearer 토큰 추가
                },
                success: function(response) {
                    console.log('이미지 업로드 성공!', response);
                    alert('이미지 업로드 성공!');
                },
                error: function(error) {
                    console.error('이미지 업로드 실패!', error);
                    alert('이미지 업로드 실패!');
                }
            });
        }
    </script>

</body>
</html>
