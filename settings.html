<link rel="stylesheet" href="css/settings/style.css" type="text/css">

<style>
    body {
        background-image: url('img/bg/ebg.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        height: 100%;
        margin: 0;
        font-family: Arial, sans-serif;
    }
</style>

<script>
    const myModal = document.getElementById('myModal')
    const myInput = document.getElementById('myInput')

    myModal.addEventListener('shown.bs.modal', () => {
        myInput.focus()
    })
</script>

<div class="profile-container" style="margin-top: 110px;">
    <div class="my-5">
        <div class="d-flex flex-column align-items-center">
            <h1 class="fw-lighter">Profile</h1>
        </div>
        <div class="loading">로딩 중...</div>
        <div class="profile-image d-flex flex-column align-items-center">
            <img class="rounded-3 mt-3" src="" alt="프로필 이미지" style="width: 10vw;"  id="profile-image"/>
        </div>
        <div class="d-flex flex-column align-items-center">
            <p class="fw-lighter"><strong>사용자:</strong> <span id="username"></span></p>
            <p class="fw-lighter"><strong>이메일:</strong> <span id="email"></span></p>
            <p class="fw-lighter"><strong>자기소개:</strong> <span id="introduction"></span></p>
            <div class="d-flex justify-content-center gap-3 mt-3">
                <button type="button" class="btn btn-outline-dark btn-sm" data-bs-toggle="modal"
                    data-bs-target="#edit-profile-modal" id="edit-profile">회원 정보 수정</button>
                <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal"
                    data-bs-target="#change-password-modal" id="change-password">비밀번호 변경</button>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#delete-account-modal"
                    id="delete-account">회원 탈퇴</button>
            </div>
        </div>
    </div>
</div>



<!-- 정보 수정 Modal -->
<div class="modal fade" id="edit-profile-modal" tabindex="-1" aria-labelledby="modal1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modal1">회원 정보 수정</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- <h2>회원 정보 수정</h2> -->
                <!-- <label for="delete-password" class="form-label mt-2">new username</label>
                <input type="text" class="form-control" id="new-username" required>

                <label for="delete-password" class="form-label mt-2">new introduction</label>
                <input type="text" class="form-control" id="new-introduction" required> -->

                <div class="form-floating">
                    <input type="text" class="form-control" id="new-username" placeholder="text">
                    <label for="new-username">Username</label>
                </div>
                
                <div class="form-floating mt-3">
                    <input type="text" class="form-control" id="new-introduction" placeholder="text">
                    <label for="new-introduction">Introduction</label>
                </div>

                <!-- <input type="text" id="new-username" placeholder="새로운 사용자명" required />
                <input type="text" id="new-introduction" placeholder="새로운 자기소개" required /> -->
                <!-- <button type="button" id="submit-edit">수정하기</button> -->
                <!-- <button type="button" class="cancel">취소</button> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-dark" id="submit-edit">확인</button>
            </div>
        </div>
    </div>
</div>


<!-- 비빌번호 변경 Modal -->
<div class="modal fade" id="change-password-modal" tabindex="-1" aria-labelledby="modal2" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modal2">회원 정보 수정</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- <h2>회원 정보 수정</h2> -->
                <!-- <label for="delete-password" class="form-label mt-2">old-password</label>
                <input type="password" class="form-control" id="old-password" required>

                <label for="delete-password" class="form-label mt-2">new password</label>
                <input type="password" class="form-control" id="new-password" required>

                <label for="delete-password" class="form-label mt-2">password confirm</label>
                <input type="password" class="form-control" id="new-password-confirm" required> -->

                <div class="form-floating">
                    <input type="password" class="form-control" id="old-password" placeholder="Password">
                    <label for="old-password">old password</label>
                  </div>

                  <div class="form-floating mt-2">
                    <input type="password" class="form-control" id="new-password" placeholder="Password">
                    <label for="new-password">new password</label>
                  </div>

                  <div class="form-floating mt-2">
                    <input type="password" class="form-control" id="new-password-confirm" placeholder="Password">
                    <label for="new-password-confirm">password confirm</label>
                  </div>

                <!-- <input type="password" id="old-password" placeholder="현재 비밀번호" required />
                <input type="password" id="new-password" placeholder="새로운 비밀번호" required />
                <input type="password" id="new-password-confirm" placeholder="비밀번호 확인" required /> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-dark" id="submit-password-change">변경하기</button>
            </div>
        </div>
    </div>
</div>


<!-- 회원 탈퇴 Modal -->
<div class="modal fade" id="delete-account-modal" tabindex="-1" aria-labelledby="modal3" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modal3">회원탈퇴</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- <p>비밀번호 입력</p> -->
                <p class="fs-6 text-danger" style="letter-spacing: 2px; line-height: 2;">회원 탈퇴를 진행하시겠습니까? <br> 탈퇴 후 모든 데이터는 삭제되며 복구할 수 없습니다.</p>
                <!-- <label for="delete-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="delete-password" required> -->

                <div class="form-floating">
                    <input type="password" class="form-control" id="delete-password" placeholder="Password" >
                    <label for="delete-password">Password</label>
                  </div>
                <!-- <input type="password" id="delete-password" placeholder="비밀번호" required /> -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-danger" id="submit-password-delete">계정삭제</button>
            </div>
        </div>
    </div>
</div>


<script>
    var emailC = null
    var usernameC = null
    var introductionC = null

    $(document).ready(function () {
        const accessToken = localStorage.getItem('access_token');
        if (!accessToken) {
            alert('로그인이 필요합니다.');
            return;
        }

        // 유저 정보 불러오기
        function loadUserProfile() {
            $.ajax({
                url: 'http://127.0.0.1:8000/api/accounts/profile/',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                success: function (data) {
                    $('#username').text(data.username || '없음');
                    $('#email').text(data.email || '없음');
                    $('#introduction').text(data.introduction || '없음');
                    if (data.profile_image) {
                        $('#profile-image').attr('src', data.profile_image);
                    } else {
                        $('#profile-image').attr('src', 'img/profile/default-profile.jpg');
                    }
                    $('.loading').hide();
                    // 수정할 때 사용될 필드에 값 채우기
                    $('#new-username').val(data.username || '');  // username 값
                    $('#new-introduction').val(data.introduction || '');  // introduction 값
                },
                error: function () {
                    $('.loading').text('프로필을 불러오는 중 오류 발생');
                }
            });
        }

        // 초기 프로필 로드
        loadUserProfile();

        // 회원 정보 수정 페이지
        // $('#edit-profile').click(function () {
        //     $('#edit-profile-form').fadeIn();
        // });

        $('#submit-edit').click(function () {
            const username = $('#new-username').val();
            const introduction = $('#new-introduction').val();
            if (username && introduction) {
                $.ajax({
                    url: 'http://127.0.0.1:8000/api/accounts/profile/',
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ username, introduction }),
                    success: function () {
                        loadUserProfile();
                        alert('회원 정보가 수정되었습니다.');
                        $('#edit-profile-modal').modal('hide');
                    },
                    error: function () {
                        alert('회원 정보 수정 중 오류 발생');
                    }
                });
            }
        });

        // 비밀번호 변경 페이지
        // $('#change-password').click(function () {
        //     $('#change-password-form').fadeIn();
        // });

        $('#submit-password-change').click(function () {

            const oldPassword = $('#old-password').val();
            const newPassword = $('#new-password').val();
            const newPasswordconfirm = $('#new-password-confirm').val();

            if (newPassword !== newPasswordconfirm) {
                alert('새로운 비밀번호와 비밀번호 확인이 일치하지 않습니다.');
                return;  // 일치하지 않으면 진행하지 않고 종료
            }

            if (oldPassword && newPassword) {
                $.ajax({
                    url: `http://127.0.0.1:8000/api/accounts/password/${$('#username').text()}/`,
                    type: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ old_password: oldPassword, new_password: newPassword, new_password_confirm: newPasswordconfirm }),
                    success: function () {
                        alert('비밀번호가 변경되었습니다.');
                        // $('.form-container').fadeOut();
                        $('#change-password-modal').modal('hide');
                    },
                    error: function () {
                        alert('비밀번호 변경 중 오류 발생');
                    }
                });
            }
        });

        // 폼 취소 버튼 처리
        // $('.cancel').click(function () {
        //     $('.form-container').fadeOut();
        // });

        // 계정 삭제
        $('#submit-password-delete').click(function () {
            // const password = prompt('비밀번호를 입력하세요:');
            const password = $('#delete-password').val();
            if (password) {
                $.ajax({
                    url: 'http://127.0.0.1:8000/api/accounts/delete/',
                    type: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({ password: password, confirm_delete: true }),
                    success: function () {
                        localStorage.removeItem('access_token');
                        $('#change-password-modal').modal('hide');
                        window.location.href = 'https://rr720.synology.me/whyding/';
                    },
                    error: function () {
                        alert('계정 삭제 중 오류 발생');
                    }
                });
            }
        });
    });
</script>